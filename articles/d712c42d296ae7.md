---
title: "Cloud Functionsでprepareにハマる"
emoji: "📦"
type: "tech"
topics: ["firebase", "typescript", "gts"]
published: true
---

Cloud Functions for Firebase を TypeScript で書こうとした時、ササッと整備できるスタイルガイドとして[gts](https://www.npmjs.com/package/gts)を使えばかなり楽だが、ハマりポイントがあった話

# `gts init`

（gts バージョンは 3.1.0 時点の話）
`gts init`すると、gts によって`packages.json`に変更が加えられる。

scripts は次のように、[prepare](https://docs.npmjs.com/cli/v7/using-npm/scripts#life-cycle-scripts)に compile、つまりは tsc を実行するスクリプトが追記される。

```json:packages.json
...
  scripts: {
    lint: 'gts lint',
    clean: 'gts clean',
    compile: 'tsc',
    fix: 'gts fix',
    prepare: 'npm run compile',
    pretest: 'npm run compile',
    posttest: 'npm run lint'
  },
...
```

しかし、この状態で`firebase deploy`すると Firebase 側で次のエラーとなり、関数のデプロイに失敗する。
当然 devDependencies は typescript はあるので tsc が見つからないと言われるのはよく分からないが、`prepare`→`npm run compile`→`tsc`が呼び出された際にパスが通ってないようである。

```
Build failed: > protobufjs@6.10.2 postinstall /workspace/node_modules/protobufjs
> node scripts/postinstall


> functions@undefined prepare /workspace
> npm run compile


> functions@ compile /workspace
> tsc

sh: 1: tsc: not found
npm ERR! code ELIFECYCLE
npm ERR! syscall spawn
npm ERR! file sh
npm ERR! errno ENOENT
npm ERR! functions@ compile: `tsc`
npm ERR! spawn ENOENT
npm ERR!
npm ERR! Failed at the functions@ compile script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /builder/home/.npm/_cacache/_logs/2021-04-18T11_44_03_823Z-debug.log
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! functions@undefined prepare: `npm run compile`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the functions@undefined prepare script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /builder/home/.npm/_logs/2021-04-18T11_44_03_857Z-debug.log; Error ID: beaf8772
```

# 解決策

`prepare`を削除するだけ。

手元の環境では`firebase.json`の predeploy で compile を呼ぶようにしていたので、prepare は必要ではなかったが、もし prepare が必要な場合は何か工夫が必要かもしれない。

```json:firebase.json
{
  "functions": {
    "predeploy": [
      "npm --prefix \"$RESOURCE_DIR\" run lint",
      "npm --prefix \"$RESOURCE_DIR\" run compile"
    ],
...
```
