---
title: "Cloud Functionsã§prepareã«ãƒãƒã‚‹"
emoji: "ğŸ“¦"
type: "tech"
topics: ["firebase", "typescript", "gts"]
published: true
---

Cloud Functions for Firebase ã‚’ TypeScript ã§æ›¸ã“ã†ã¨ã—ãŸæ™‚ã€ã‚µã‚µãƒƒã¨æ•´å‚™ã§ãã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦[gts](https://www.npmjs.com/package/gts)ã‚’ä½¿ãˆã°ã‹ãªã‚Šæ¥½ã ãŒã€ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆãŒã‚ã£ãŸè©±

# `gts init`

ï¼ˆgts ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 3.1.0 æ™‚ç‚¹ã®è©±ï¼‰
`gts init`ã™ã‚‹ã¨ã€gts ã«ã‚ˆã£ã¦`packages.json`ã«å¤‰æ›´ãŒåŠ ãˆã‚‰ã‚Œã‚‹ã€‚

scripts ã¯æ¬¡ã®ã‚ˆã†ã«ã€[prepare](https://docs.npmjs.com/cli/v7/using-npm/scripts#life-cycle-scripts)ã« compileã€ã¤ã¾ã‚Šã¯ tsc ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¿½è¨˜ã•ã‚Œã‚‹ã€‚

```json:packages.json
...
  scripts: {
    lint: 'gts lint',
    clean: 'gts clean',
    compile: 'tsc',
    fix: 'gts fix',
    prepare: 'npm run compile',
    pretest: 'npm run compile',
    posttest: 'npm run lint'
  },
...
```

ã—ã‹ã—ã€ã“ã®çŠ¶æ…‹ã§`firebase deploy`ã™ã‚‹ã¨ Firebase å´ã§æ¬¡ã®ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã€é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã™ã‚‹ã€‚
å½“ç„¶ devDependencies ã¯ typescript ã¯ã‚ã‚‹ã®ã§ tsc ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨è¨€ã‚ã‚Œã‚‹ã®ã¯ã‚ˆãåˆ†ã‹ã‚‰ãªã„ãŒã€`prepare`â†’`npm run compile`â†’`tsc`ãŒå‘¼ã³å‡ºã•ã‚ŒãŸéš›ã«ãƒ‘ã‚¹ãŒé€šã£ã¦ãªã„ã‚ˆã†ã§ã‚ã‚‹ã€‚

```
Build failed: > protobufjs@6.10.2 postinstall /workspace/node_modules/protobufjs
> node scripts/postinstall


> functions@undefined prepare /workspace
> npm run compile


> functions@ compile /workspace
> tsc

sh: 1: tsc: not found
npm ERR! code ELIFECYCLE
npm ERR! syscall spawn
npm ERR! file sh
npm ERR! errno ENOENT
npm ERR! functions@ compile: `tsc`
npm ERR! spawn ENOENT
npm ERR!
npm ERR! Failed at the functions@ compile script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /builder/home/.npm/_cacache/_logs/2021-04-18T11_44_03_823Z-debug.log
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! functions@undefined prepare: `npm run compile`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the functions@undefined prepare script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /builder/home/.npm/_logs/2021-04-18T11_44_03_857Z-debug.log; Error ID: beaf8772
```

# è§£æ±ºç­–

`prepare`ã‚’å‰Šé™¤ã™ã‚‹ã ã‘ã€‚

æ‰‹å…ƒã®ç’°å¢ƒã§ã¯`firebase.json`ã® predeploy ã§ compile ã‚’å‘¼ã¶ã‚ˆã†ã«ã—ã¦ã„ãŸã®ã§ã€prepare ã¯å¿…è¦ã§ã¯ãªã‹ã£ãŸãŒã€ã‚‚ã— prepare ãŒå¿…è¦ãªå ´åˆã¯ä½•ã‹å·¥å¤«ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œãªã„ã€‚

```json:firebase.json
{
  "functions": {
    "predeploy": [
      "npm --prefix \"$RESOURCE_DIR\" run lint",
      "npm --prefix \"$RESOURCE_DIR\" run compile"
    ],
...
```
