---
title: "Maestroã‚’ç”¨ã„ãŸE2Eãƒ†ã‚¹ãƒˆã§App Checkã‚’çªç ´ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ios, firebase, e2e, flutter, maestro]
published: true
---

# ã¯ã˜ã‚ã«

[Firebase App Check](https://firebase.google.com/docs/app-check)ã¯ä¸æ­£ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ Firebase ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚

iOS Simulator ã®ã‚ˆã†ãªé–‹ç™ºç’°å¢ƒã¯ä¸æ­£ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨è¦‹åšã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ç‰¹åˆ¥ã«[ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³](https://firebase.google.com/docs/app-check/flutter/debug-provider)ã‚’ App Check ã«ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ‡ãƒã‚¤ã‚¹æ¯ã«ç•°ãªã‚Šã€ã¾ãŸã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹åº¦ã«æ–°ãŸã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã“ã®**æ–°ãŸã«ç”Ÿæˆã•ã‚Œã‚‹**ã¨ã„ã†æŒ™å‹•ãŒ [Maestro](https://docs.maestro.dev/) ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹éš›ã«å•é¡Œã«ãªã‚Šã¾ã™ã€‚

## Maestro ã§ã®å•é¡Œ

Maestro ã®ã‚ˆã†ã«å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚’è‡ªå‹•æ“ä½œã—ã¦ E2E ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹éš›ã€Firebase ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã« App Check ã®ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ã—ã‹ã—å‰è¿°ã—ãŸã‚ˆã†ã«ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ¯å›æ–°ãŸã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã®ãŸã³ã«æ‰‹å‹•ã§ç™»éŒ²ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚

App Check ã®å…¬å¼ã®æ–¹æ³•ã¨ã—ã¦ã€Environment Variables ã® `FIRAAppCheckDebugToken` ã«ä»»æ„ã®å€¤ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ä»»æ„ã®ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ã€‚

https://firebase.google.com/docs/app-check/ios/debug-provider?#ci
https://github.com/firebase/firebase-ios-sdk/blob/11.10.0/FirebaseAppCheck/Sources/Public/FirebaseAppCheck/FIRAppCheckDebugProvider.h#L73-L80
https://github.com/firebase/firebase-ios-sdk/issues/8851#issuecomment-952365817

ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã¯ã‚ãã¾ã§`xcodebuild test`ãªã© Xcode ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã™ã‚‹æ™‚ã«ã ã‘æœ‰åŠ¹ã«ãªã‚‹ã‚‚ã®ã§ã‚ã‚Šã€æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚’æ“ä½œã™ã‚‹ Maestro ã§ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

ã¤ã¾ã‚Šãªã‚“ã¨ã‹ã—ã¦ iOS Simulator ã®ç’°å¢ƒå¤‰æ•°ã®`FIRAAppCheckDebugToken`ã«å€¤ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## è§£æ±ºæ–¹æ³•

å®Ÿã¯`SIMCTL_CHILD_`ã¨ã„ã†ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ç’°å¢ƒå¤‰æ•°ã¯ iOS Simulator ã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
`xcrun simctl boot`ã®èª¬æ˜ã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

```sh
xcrun simctl boot
Boot a device or device pair.
Usage: simctl boot <device> [--arch=<arch>] [--disabledJob=<job>] [--enabledJob=<job>]

	--arch=<arch>           Specify the architecture to use when booting the simulator (eg: 'arm64' or 'x86_64')
	--disabledJob=<job>     Disables the given launchd job. Multiple jobs can be disabled by passing multiple flags.
	--enabledJob=<job>      Enables the given launchd job when it would normally be disabled.
	                        Multiple jobs can be enabled by passing multiple flags.


If you want to set environment variables in the resulting environment, set them in the calling environment with a SIMCTL_CHILD_ prefix.
```

ãã®ä»•æ§˜ã‚’åŸºã«ã—ã¦ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ãƒã‚¤ãƒ³ãƒˆã¯ **`SIMCTL_CHILD_FIRAAppCheckDebugToken`ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‹ã‚‰ã€iOS Simulator ã‚’èµ·å‹•ã™ã‚‹ã“ã¨**ã§ã™ã€‚

```sh
# iOS Simulatorã«æ¸¡ã—ãŸã„FIRAAppCheckDebugTokenã«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦export
# ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã¯`.env`ãªã©ã‹ã‚‰å‚ç…§ã—ã¦ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†
export SIMCTL_CHILD_FIRAAppCheckDebugToken="17A9AC77-BE74-4DCA-8628-981D39E80785"

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹iOS Simulatorã®åå‰
# äº‹å‰ã«Simulatorã¯ä½œæˆã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚èµ·å‹•ã—ã¦ãŠãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
TEST_DEVICE_NAME="E2E Test"

# ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
# ä»Šå›ã¯Flutterã§ã™ãŒã€åˆ¥ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚åŒã˜ã ã¨æ€ã„ã¾ã™
APP_PATH="build/ios/iphonesimulator/Runner.app"
rm -rf "$APP_PATH"
fvm flutter build ios --debug --simulator --flavor stg

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ã™ã‚‹
# æ—¢ã«èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã¯å†èµ·å‹•
TEST_DEVICE_UDID=$(xcrun simctl list devices --json | jq -r ".devices[][] | select(.name == \"$TEST_DEVICE_NAME\") | .udid")
xcrun simctl shutdown "$TEST_DEVICE_UDID" || true
xcrun simctl boot "$TEST_DEVICE_UDID"

# ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
xcrun simctl install "$TEST_DEVICE_UDID" "$APP_PATH"

# Maestroã‚’å®Ÿè¡Œ
maestro test .maestro/test.yml

# ãƒ†ã‚¹ãƒˆç”¨ã®iOS Simulatorã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
xcrun simctl shutdown "$TEST_DEVICE_UDID" || true
```

### å‚è€ƒ

https://github.com/invertase/react-native-firebase/discussions/6184#discussioncomment-4365178

## çµæœ

æœ€å¾Œã®ãƒãƒ£ãƒƒãƒˆã£ã½ã„ç”»é¢ã«åˆ°é”ã™ã‚‹ãŸã‚ã«ã¯ Firebase Authentication ã§åŒ¿åèªè¨¼ãŒæˆåŠŸã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ç„¡äº‹ã«ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã§ App Check ã‚’çªç ´ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

https://youtu.be/9QF-ndrvSOw

https://github.com/KoheiKanagu/blooms/pull/277
