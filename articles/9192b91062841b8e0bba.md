---
title: "Flutterã§æ–°è¦ã‚¢ãƒ—ãƒªä½œã‚‹æ™‚ã«ã‚„ã‚‹ã“ã¨ã¾ã¨ã‚"
emoji: "ğŸ›«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Flutter, Firebase]
published: false
---

Flutterã§æ–°è¦ã«ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹æ™‚ã«ãƒ†ãƒ³ãƒ—ãƒ¬çš„ã«å¤§ä½“åŒã˜ã‚ˆã†ãªäº‹ã‚’ã‚„ã£ã¦ã„ã‚‹ãŒã€ã„ã¤ã‚‚å¿˜ã‚Œã‚‹ã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã€‚

Flutterã¯çµ¶è³›é–‹ç™ºä¸­ãªã®ã§ã€æœ¬ç¨¿ã«ãŠã‘ã‚‹è¨˜è¼‰ã¯å½“æ™‚ã¯ã“ã‚Œã§ã†ã¾ãã„ã£ã¦ã„ãŸãã‚‰ã„ã«ç•™ã‚ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚
ã¾ãŸã€æœ¬ç¨¿ã¯å€‹äººçš„ãªãƒ¡ãƒ¢ã®æ„å‘³åˆã„ãŒå¼·ã„ãŸã‚ã€å‰²æ„›ã—ã¦ã„ã‚‹èª¬æ˜ãŒå¤šã€…ã‚ã‚Šã¾ã™ã€‚

# ç’°å¢ƒ

```
macOS 11.2.3
Flutter 2.0.3
```

# Flutter Create

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ã€‚

```bash
flutter create --org com.example your_project_name
```

## ãƒ¡ãƒ¢

`flutter create -h`ã«æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚Šã€iOSã¨Androidãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…å´ã¯`Swift`ã¨`Kotlin`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æŒ‡å®šã•ã‚Œã‚‹ã®ã§ã€ã‚‚ã—å¤‰æ›´ã—ãŸã„å ´åˆã¯`--ios-language`ã‚„`--android-language`ã§æŒ‡å®šã™ã‚‹ã“ã¨ã€‚

orgã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€å¾Œã‹ã‚‰å¤‰æ›´ã™ã‚‹ã®ã¯é¢å€’ã€‚
ç‰¹ã«`android/app/src/main/kotlin/**`ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚‚å½±éŸ¿ã™ã‚‹ãŸã‚ã€æƒé™¤ãŒé¢å€’ãªã®ã§å¾Œã‹ã‚‰å¤‰æ›´ã™ã‚‹ãªã‚‰æ³¨æ„ã€‚

# Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œã‚‹

Cloud Firestoreã‚„Authenticationã‚’ä½¿ã‚ãªã„ã‹ã‚‰Firebaseå¿…è¦ãªã„å ´åˆã‚‚ã‚ã‚‹ã¨æ€ã†ãŒã€[Crashlytics](https://firebase.google.com/products/crashlytics)ã‚„[Performance](https://firebase.google.com/products/performance)ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ãªã®ã§è£æ–¹ã¨ã—ã¦ã ã‘ã§ã‚‚å°å…¥ã™ã‚‹ã®ã¯ã‚ªã‚¹ã‚¹ãƒ¡ã€‚

- https://console.firebase.google.com/

devã‚„prodãªã©å¿…è¦ãªç’°å¢ƒåˆ†ã ã‘ä½œã£ã¦ãŠã“ã†ã€‚
`ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ç¢ºèª`ã¨ã‹ã„ã†ç–é€šç¢ºèªã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã¨ã‚Šã‚ãˆãšç„¡è¦–ã€‚

## ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®GCPãƒªã‚½ãƒ¼ã‚¹ ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

å¤§æŠµã®å ´åˆã¯æ±äº¬ã§ã‚ã‚‹`asia-northeast1`ã§è‰¯ã„ã¨ã¯æ€ã†ã€‚

## App Distribution

App Distributionã‚’åˆ©ç”¨ã™ã‚‹ã¤ã‚‚ã‚Šãªã‚‰ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰iOS/Androidå„ã‚¢ãƒ—ãƒªæ¯ã«`é–‹å§‹`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãŠãã“ã¨ã‚’å¿˜ã‚Œãšã«ã€‚
äºˆã‚é–‹å§‹ã—ã¦ãŠã‹ãªã„ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

```
Error: App Distribution could not find your app 1:hoge:ios:hoge. Make sure to onboard your app by pressing the "Get started" button on the App Distribution page in the Firebase console: https://console.firebase.google.com/project/_/appdistribution
```

## æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«

æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒãƒãƒƒã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã„ã„ãŒã€[firebase ã‚³ãƒãƒ³ãƒ‰](https://firebase.google.com/docs/cli?hl=ja)ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚ã§ãã‚‹ã®ã§ã€[ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/downloadFirebaseAppConfiguration.sh)ã‚’æ›¸ã„ã¦ãŠãã¨æ¥½ã€‚
ï¼ˆã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯å¾Œè¿°ã™ã‚‹Flavorå¯¾å¿œã®ãŸã‚ã«é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«åã§é…ç½®ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ï¼‰

# Androidã®ç½²å

keystoreã¯GUIã‹ã‚‰ç”Ÿæˆã—ã¦ã‚‚ã„ã„ã—ã€[android \- How can I create a keystore? \- Stack Overflow](https://stackoverflow.com/a/15330139/12856415)ã‚’å‚è€ƒã«ã—ã¦ç”Ÿæˆã—ã¦ã‚‚ã‚ˆã„

```sh:ä¾‹ãˆã°
keytool -genkey -v -keystore release.keystore -alias key0 -keyalg RSA -keysize 2048 -validity 10000
keytool -importkeystore -srckeystore release.keystore -destkeystore release.keystore -deststoretype pkcs12
```

`android/app/build.gradle`ã§æŒ‡å®šã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€`android/app/release.keystore`ã«ç½®ãã¨ã‚ˆã„ã€‚

SHAã¯[Authenticating Your Client Â \|Â  Android ç”¨ Google API Â \|Â  Google Developers](https://developers.google.com/android/guides/client-auth)ãªã©ã‚’å‚è€ƒã«ã—ã¦ç¢ºèªã—ã¦ã€Firebaseã«ç™»éŒ²ã—ã¦ãŠãã€‚

```sh:ä¾‹ãˆã°
keytool -list -v -alias key0 --keystore release.keystore
```

## build.gradle

`signingConfigs`ã«keystoreã‚’è¿½è¨˜ã—ã€releaseãƒ“ãƒ«ãƒ‰æ™‚ã«åˆ©ç”¨ã™ã‚‹ã€‚
keystoreã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…è¦ã«å¿œã˜ã¦éš ãã†ã€‚
å‚è€ƒï¼š [ä»Šæ›´ãªãŒã‚‰ Android ã® keystore ã¨ ç½²å\(signingConfigs\) ã®ç®¡ç†ãƒ»é‹ç”¨ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ãŸ \- Qiita](https://qiita.com/taki4227/items/c5685ec722a195764237)

```android/app/build.gradle
    signingConfigs {
        release {
            storeFile file("release.keystore")
            storePassword "android"
            keyAlias "key0"
            keyPassword "android"
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
```

# Flavor

`dart-define`ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚’ç´¹ä»‹
ï¼ˆ`--flavor`ã‚’ä½¿ã£ãŸå ´åˆã‚ˆã‚Šã‚‚ç°¡å˜ï¼Ÿ)

## Android

ã‚¢ãƒ—ãƒªåã®éƒ¨åˆ†ã‚’`@string/app_name`ã«ä¿®æ­£

```xml:android/app/src/main/AndroidManifest.xml
<application
    android:label="@string/app_name">
```

`dart-define`ã‹ã‚‰ã®å…¥åŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³IDã®Suffixã¨ã‚¢ãƒ—ãƒªåã«ã‚»ãƒƒãƒˆã™ã‚‹

```gradle:android/app/build.gradle
def dartEnvironmentVariables = [
        APP_NAME: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',
        APP_SUFFIX: null,
        APP_ENV: 'default'
]

if (project.hasProperty('dart-defines')) {
    dartEnvironmentVariables = dartEnvironmentVariables + project.property('dart-defines')
            .split(',')
            .collectEntries { entry ->
                def pair = URLDecoder.decode(entry).split('=')
                [(pair.first()): pair.last()]
            }
}
android {
...
    defaultConfig {
        applicationIdSuffix dartEnvironmentVariables.APP_SUFFIX
        resValue "string", "app_name", dartEnvironmentVariables.APP_NAME
    }
...
}

```

### Firebaseã‚’åˆ©ç”¨ã™ã‚‹ãªã‚‰

Firebaseã®SDKã¯`android/app/google-services.json`ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã‚€ã®ã§Flavorã«å¿œã˜ã¦å·®ã—æ›¿ãˆã¦ã‚ã’ã‚‹ã€‚

ã¾ãš[Android Installation \| FlutterFire](https://firebase.flutter.dev/docs/installation/android)ã«å¾“ã£ã¦`android/build.gradle`ãªã©ã«ä¾å­˜ã‚’è¿½åŠ ã—ã¦ã„ãã€‚

æ¬¡ã«ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã€Flavorã«å¿œã˜ãŸ`google-services.json`ã‚’é…ç½®ã™ã‚‹ã€‚

```gradle:android/app/build.gradle
task copyGoogleServicesJson(type: Copy) {
    from "google-services-${dartEnvironmentVariables.APP_ENV}.json"
    into './'
    rename "(.+)-${dartEnvironmentVariables.APP_ENV}.json", '$1.json'
}

tasks.whenTaskAdded { task ->
    if (task.name == 'processDebugGoogleServices') {
        task.dependsOn copyGoogleServicesJson
    }
    if (task.name == 'processReleaseGoogleServices') {
        task.dependsOn copyGoogleServicesJson
    }
}
```

æœ€å¾Œã«`android/app/google-services.json`ã¯Flavorã‚’å¤‰ãˆã‚‹æ¯ã«å¤‰æ›´ã•ã‚Œã‚‹ã®ã§gitignoreã«è¿½åŠ ã—ã¦ãŠãã€‚

```sh
echo "android/app/google-services.json" >> .gitignore
```

## iOS

Info.plistã«`APP_NAME`ã‚’ã‚»ãƒƒãƒˆã€‚
`PRODUCT_NAME`ã«ã—ã¦ãŠãã¨exportã™ã‚‹éš›ã«`Runner.ipa`ã§å‡ºåŠ›ã•ã‚Œã‚‹

```diff:ios/Runner/Info.plist
        <key>CFBundleName</key>
-       <string>ã‚¢ãƒ—ãƒªã®åå‰</string>
+       <string>$(PRODUCT_NAME)</string>
        <key>CFBundleDisplayName</key>
-       <string>$(DISPLAY_NAME)</string>
+       <string>$(APP_NAME)</string>
```

---

`Build Settings`ã‹ã‚‰`Product Bundle Identifier`ã‚’æ¤œç´¢ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«`APP_SUFFIX`ã‚’ã‚»ãƒƒãƒˆ

```
com.example.app$(APP_SUFFIX)
```

ã¤ã¾ã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªå¤‰æ›´ã«ãªã‚‹

```diff:ios/Runner.xcodeproj/project.pbxproj
- PRODUCT_BUNDLE_IDENTIFIER = com.example.app;
+ PRODUCT_BUNDLE_IDENTIFIER = "com.example.app$(APP_SUFFIX)";
```

---

æ¬¡ã«Runnerã®Schemeã‚’Editã—ã¦ã€Buildã®Pre-actionsã«[flutter 1\.19 parse sh script](https://gist.github.com/TatsuUkraine/99d2af08f6dfef17982299afa56f6507#file-ios_parse-sh)ã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã€‚
æœ€å¾Œã®å‡¦ç†ã®xcconfigã«æ›¸ãå‡ºã™éƒ¨åˆ†ã¯é©åˆ‡ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã€‚

```sh:ä»Šå›ã®ä¾‹ã ã¨
printf "%s\n" "${define_items[@]}"|grep '^APP_' >> ${SRCROOT}/Flutter/Generated.xcconfig
```

`Provide build settings from`ã¯`Runner`ã‚’é¸æŠã™ã‚‹ã€‚

---

ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§Provisioning Profileã‚’ç®¡ç†ã—ãŸã„ã®ã§Signingã®Automatically manage signingã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2021-04-05 17.54.39.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/46022/714b5459-0395-2412-f185-991072c2bc96.png)

`Build Settings`ã‹ã‚‰`Provisioning Profile`ã‚’æ¤œç´¢ã—ã¦ã€å€¤ã«`$(APP_PROVISIONING_PROFILE_SPECIFIER)`ã‚’è¨­å®šã™ã‚‹ã€‚
ã¤ã¾ã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªå¤‰æ›´ã«ãªã‚‹ã€‚

```diff:ios/Runner.xcodeproj/project.pbxproj
- PROVISIONING_PROFILE_SPECIFIER = "";
+ PROVISIONING_PROFILE_SPECIFIER = "$(APP_PROVISIONING_PROFILE_SPECIFIER)";
```

### Firebaseã‚’åˆ©ç”¨ã™ã‚‹ãªã‚‰

Firebaseã®SDKã¯`ios/Runner/GoogleService-Info.plist`ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã‚€ã®ã§Flavorã«å¿œã˜ã¦å·®ã—æ›¿ãˆã¦ã‚ã’ã‚‹ã€‚

ã¾ãšé©å½“ãªå†…å®¹ã§`GoogleService-Info.plist`ã‚’ä½œã£ã¦ã€Xcodeã®`Project Navigator`ã§`Runner`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦`GoogleService-Info.plist`ã¸ã®å‚ç…§ã‚’ä½œã£ã¦ãŠãã€‚
å‚è€ƒï¼š [iOS Installation \| FlutterFire](https://firebase.flutter.dev/docs/installation/ios)

```sh
echo '
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
</dict>
</plist>
' > ios/Runner/GoogleService-Info.plist
```

`Build Phases`ã®`New Run Script Phase`ã§[GoogleService\-Info\.plist ã‚’ Flavor æ¯ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ RunScript dart\-define ã‚’ä½¿ã£ãŸå ´åˆ](https://gist.github.com/KoheiKanagu/82d18621ca57e96a0a4e4a456383c006)ã‚’ã‚³ãƒ”ãƒšã€‚

ä½œã£ãŸRun Scriptã®`Output Files`ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```
$SRCROOT/Runner/GoogleService-Info.plist
```

ä½œã£ãŸRun Scriptã¯`Copy Bundle Resources`ã‚ˆã‚Šã‚‚ä¸Šã«é…ç½®ã™ã‚‹ã€‚

å„Flavorã®GoogleService-Info.plistã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é…ç½®ã—ã¦ãŠã

- `ios/Runner/GoogleService-Info-dev.plist`
- `ios/Runner/GoogleService-Info-prod.plist`

æœ€å¾Œã«`ios/Runner/GoogleService-Info.plist`ã¯Flavorã‚’å¤‰ãˆã‚‹æ¯ã«å¤‰æ›´ã•ã‚Œã‚‹ã®ã§gitignoreã«è¿½åŠ ã—ã¦ãŠãã€‚

```sh
echo "ios/Runner/GoogleService-Info.plist" >> .gitignore
```

### Runner.entitlements

Flavoræ¯ã«App Groupsã‚„Associated Domainsã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆã€`./ios/Runner/Runner.entitlements`ã«ã¯æ¬¡ã®ã‚ˆã†ã«å¤‰æ•°ã«ã—ã¦ãŠãã€`dart-define`ã§æ¸¡ã™

```xml:./ios/Runner/Runner.entitlements
	<key>com.apple.developer.associated-domains</key>
	<array>
		<string>${APP_ASSOCIATED_DOMAIN}</string>
	</array>
```

## Flutter

ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦`dart-define`ã§å€¤ã‚’æ¸¡ã™
ï¼ˆ`APP_NAME="devã‚¢ãƒ—ãƒª"`ã®ã‚ˆã†ã«ã™ã‚‹ã¨`"`ã¾ã§æ¸¡ã•ã‚Œã¦ã—ã¾ã†ã®ã§æ³¨æ„ï¼‰
ï¼ˆ`APP_SUFFIX`ãŒä¸è¦ã®å ´åˆã¯`--dart-define APP_SUFFIX=""`ã§ã¯ãªãå‰Šé™¤ã™ã‚‹ï¼‰

```sh
flutter build ios \
--dart-define APP_NAME=devã‚¢ãƒ—ãƒª \
--dart-define APP_SUFFIX=.dev \
--dart-define APP_ENV=dev \
--dart-define APP_ASSOCIATED_DOMAIN=applinks:com.example.page.link
```

Flutterå´ã§å€¤ã‚’ä½¿ã„ãŸã„ãªã‚‰ã“ã®ã‚ˆã†ã«ã™ã‚‹ã€‚ï¼ˆfinalã§ã¯ãªãconstã«ã™ã‚‹ã“ã¨ï¼‰

```dart
  const appName = String.fromEnvironment('APP_NAME', defaultValue: 'unknownName');
  const appSuffix = String.fromEnvironment('APP_SUFFIX', defaultValue: 'unknownSuffix');
  const appEnv = String.fromEnvironment('APP_ENV', defaultValue: 'unknownEnv');
```

## AndroidStudio

æ‰€å®šã®`Run/Debug Configurations`ã®`Additional arguments`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½è¨˜ã—ã¦å€¤ã‚’æ¸¡ã™
ï¼ˆ`APP_NAME="devã‚¢ãƒ—ãƒª"`ã®ã‚ˆã†ã«ã™ã‚‹ã¨`"`ã¾ã§æ¸¡ã•ã‚Œã¦ã—ã¾ã†ã®ã§æ³¨æ„ï¼‰
ï¼ˆ`APP_SUFFIX`ãŒä¸è¦ã®å ´åˆã¯`--dart-define APP_SUFFIX=""`ã§ã¯ãªãå‰Šé™¤ã™ã‚‹ï¼‰

```sh
--dart-define APP_NAME=devã‚¢ãƒ—ãƒª --dart-define APP_SUFFIX=.dev --dart-define APP_ENV=dev
```

[runConfigurations ã®ä¾‹](https://github.com/KoheiKanagu/my_flutter_app_template/tree/master/.idea/runConfigurations)

Configurationsã‚‚ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å ´åˆã¯`git add --force`ãŒå¿…è¦ã€‚
ï¼ˆ`flutter create`ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`.idea/`ãŒgitignoreã•ã‚Œã¦ã„ã‚‹ã®ã§æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰

```sh
git add --force .idea/runConfigurations/*.xml
```

## Visual Studio Code

```json
{
  "name": "dev",
  "request": "launch",
  "program": "lib/main.dart",
  "type": "dart",
  "args": [
    "--dart-define=APP_NAME=devã‚¢ãƒ—ãƒª",
    "--dart-define=APP_SUFFIX=.dev",
    "--dart-define=APP_ENV=dev",
    "--dart-define=APP_ASSOCIATED_DOMAIN=applinks:com.example.page.link"
  ]
}
```

ï¼ˆ`APP_NAME="devã‚¢ãƒ—ãƒª"`ã®ã‚ˆã†ã«ã™ã‚‹ã¨`"`ã¾ã§æ¸¡ã•ã‚Œã¦ã—ã¾ã†ã®ã§æ³¨æ„ï¼‰
ï¼ˆ`APP_SUFFIX`ãŒä¸è¦ã®å ´åˆã¯`--dart-define APP_SUFFIX=""`ã§ã¯ãªãå‰Šé™¤ã™ã‚‹ï¼‰

[launch.json ã®ä¾‹](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/.vscode/launch.json)

## å‚è€ƒæ–‡çŒ®

- [Flutter 1\.17 â€” no more Flavors, no more iOS Schemas\. Command argument that changes everything \| by Denis Beketsky \| ITNEXT](https://itnext.io/flutter-1-17-no-more-flavors-no-more-ios-schemas-command-argument-that-solves-everything-8b145ed4285d)
- [dart\-define ã§ Flutter ã‚¢ãƒ—ãƒªã® Firebase é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã‚’ä½¿ã„åˆ†ã‘ã‚‹ iOS ç·¨ \- Qiita](https://qiita.com/tetsufe/items/3f2257ac12f812d3f2d6)
- [dart\-define ã§ Flutter ã‚¢ãƒ—ãƒªã® Firebase é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã‚’ä½¿ã„åˆ†ã‘ã‚‹ Android ç·¨ \- Qiita](https://qiita.com/tetsufe/items/29cc779592171dcfb7aa)
- [ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã«ã‚ˆã‚‹ App Groups ã‚’å¤‰æ›´ã™ã‚‹è¨­å®šæ–¹æ³• \- Qiita](https://qiita.com/dolfalf/items/3db85bdae0c18985314a)

# è¼¸å‡ºã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

ã€Œã„ã„ãˆã€ã¨ç­”ãˆã‚‹å ´åˆã¯Info.plistã«ã‚ã‚‰ã‹ã˜ã‚è¿½è¨˜ã—ã¦ãŠãã¨æ‰‹å‹•ã§ã„ã„ãˆã™ã‚‹å¿…è¦ãŒãªã„ã®ã§æ¥½ã€‚

```diff:ios/Runner/Info.plist
+	<key>ITSAppUsesNonExemptEncryption</key>
+	<false/>
```

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-12-16 10.08.09.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/46022/ff04f0c1-dd4e-261c-b1a6-f065bbb0dc55.png)

# FlutterFire

å°å…¥ã—ãŸã„Pluginã‚’é¸ã¼ã†ï¼ï¼ï¼
https://firebase.flutter.dev/

å°å…¥æ–¹æ³•ã¯å„Pluginã®READMEãŒæœ€æ–°ã§æ­£ç¢ºãªã®ã§å‰²æ„›ã€‚

## Improve iOS Build Times

iOSã®Firestore SDKã¯C++ã§50ä¸‡è¡Œã‚ã‚‹ã‚‰ã—ã„ã®ã§ã€æ™®é€šã«å‚ç…§ã™ã‚‹ã¨ãƒ“ãƒ«ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚
ãã“ã§ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‚ç…§ã™ã‚‹ã¨å¤§å¹…ã«ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®ã§ãã‚‹ã®ã§ãŠã™ã™ã‚ã€‚
[FlutterFire Overview \| FlutterFire](https://firebase.flutter.dev/docs/overview#improve-ios-build-times)

# ã‚³ãƒ¼ãƒ‰ã®ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬

ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«`--coverage`ã‚’ä»˜ä¸ã™ã‚Œã°`lcov.info`ãŒå‡ºåŠ›ã•ã‚Œã‚‹

```sh
flutter test --coverage --coverage-path=coverage/lcov.info
```

ãŸã ã—ã€ã“ã‚Œã¯**ãƒ†ã‚¹ãƒˆã®å¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã®çµæœã®ã¿**ãŒå‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å…¨ãæ›¸ã„ã¦ã„ãªã„ã¨`lcov.info`ã«ã¯ä½•ã‚‚å‡ºåŠ›ã•ã‚Œãªã„ã€‚

ãã“ã§ã€å…¨éƒ¨ã®dartãƒ•ã‚¡ã‚¤ãƒ«ã‚’importã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¦ãŠã‘ã°ã€`flutter test --coverage `ã—ãŸæ™‚ã«å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ãŒ`lcov.info`ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹

```test/coverage_test.dart
import 'package:example_app/hoge.dart';

void main() {}
```

æ‰‹å‹•ã§ã‚„ã‚‹ã®ã¯é¢å€’ãªã®ã§[ãƒ˜ãƒ«ãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](https://github.com/KoheiKanagu/dart_full_coverage)ã§ç”Ÿæˆã™ã‚‹

```sh
curl https://raw.githubusercontent.com/KoheiKanagu/dart_full_coverage/master/dart-coverage-helper | sh
```

gitignoreã‚‚ã—ã¦ãŠã

```sh
echo "lcov.info" >> .gitignore
```

## å‚è€ƒ

[Flutter test coverage will not report untested files Â· Issue \#27997 Â· flutter/flutter](https://github.com/flutter/flutter/issues/27997)
[How can I generate test coverage of untested files on my flutter tests? \- Stack Overflow](https://stackoverflow.com/questions/54602840/how-can-i-generate-test-coverage-of-untested-files-on-my-flutter-tests)
[priezz/dart_full_coverage: Helper for full tests coverage checkup for you Dart/Flutter project](https://github.com/priezz/dart_full_coverage)

# CICDã«ã¤ã„ã¦

GitHub Actionsã§ã®ä¾‹ã‚’ç¤ºã™ã€‚
ã”å­˜çŸ¥ã®é€šã‚ŠmacOSã®ãƒ©ãƒ³ãƒŠãƒ¼ã¯[ãã“ãã“ã®ãŠå€¤æ®µ](https://docs.github.com/ja/github/setting-up-and-managing-billing-and-payments-on-github/about-billing-for-github-actions)ãªã®ã§ã€å¿…è¦ã«å¿œã˜ã¦self-hostedã«ã™ã‚‹ã¨è‰¯ã„ã€‚

## ã‚¸ãƒ§ãƒ–ã®æµã‚Œ

è©³ç´°ã¯å‰²æ„›ã™ã‚‹ãŒã€git-flowã«åˆã‚ã›ã‚‹

[pull_requests\.yml](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/.github/workflows/pull_requests.yml)

1. ãƒ—ãƒ«ãƒªã‚¯ä½œæˆ/æ›´æ–°ã•ã‚ŒãŸã‚‰é–‹å§‹
2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
3. Codecov
4. Slackã§é€šçŸ¥

[releases\.yml](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/.github/workflows/releases.yml)

1. ãƒ—ãƒ«ãƒªã‚¯ãŒmasterã‹developã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰é–‹å§‹
2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
3. Codecov
4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ã‚’è²¼ã‚‹
5. Releaseã‚’ä½œæˆ
6. release/\*ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰masterãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹éš›ã«ã¯developãƒ–ãƒ©ãƒ³ãƒã«`#minor`ã¨ç©ºã‚³ãƒŸãƒƒãƒˆ
7. Slackã§é€šçŸ¥
8. ãƒ“ãƒ«ãƒ‰ï¼ˆdevã®iOSãƒ»devã®Androidãƒ»prodã®iOSãƒ»prodã®Androidã‚’ãƒ‘ãƒ©ãƒ¬ãƒ«ã«å®Ÿè¡Œï¼‰
9. Release Assetã«æˆæœç‰©ï¼ˆapkã€aabã€ipaï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
10. App Distributionã§é…å¸ƒ
11. Slackã§é€šçŸ¥

`TODO`ã¨ã—ã¦ã„ã‚‹éƒ¨åˆ†ã«ã¯é©åˆ‡ãªå€¤ã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚
2ã¤ã¨ã‚‚`.github/workflows/`ã«é…ç½®ã™ã‚‹

### bumpingï¼ˆreleases.ymlã®ã‚¹ãƒ†ãƒƒãƒ—6ã«ã¤ã„ã¦ï¼‰

ã‚¿ã‚°ã‚’æŒ¯ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ©Ÿèƒ½ã§ã€ã‚³ãƒŸãƒƒãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã«`#minor`ãªã©ã¨æ›¸ãã¨bumpã—ã¦ãã‚Œã‚‹ã®ã§ã€ãƒªãƒªãƒ¼ã‚¹ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§developã«`#minor`ã¨ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã“ã¨ã§bumpã•ã‚Œã‚‹
[anothrNick/github\-tag\-action: A Github Action to tag a repo on merge\.](https://github.com/anothrNick/github-tag-action#bumping)

## Secrets

ãƒªãƒã‚¸ãƒˆãƒªã®Secretsã«ä»¥ä¸‹ã‚’ã‚»ãƒƒãƒˆã—ã¦ãŠã

- [Slack API: Applications \| Slack](https://api.slack.com/apps)ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦Incoming Webhooksã®Webhook URLã‚’`SLACK_WEBHOOK_URL`ã«ã‚»ãƒƒãƒˆ
- [Firebase CLI ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://firebase.google.com/docs/cli?hl=ja#cli-ci-systems)ã‚’å‚è€ƒã«ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦`FIREBASE_TOKEN`ã«ã‚»ãƒƒãƒˆï¼ˆ[Firebase App Distribution](https://firebase.google.com/docs/app-distribution?hl=ja)ã‚’ä½¿ã‚ãªã„ãªã‚‰ä¸è¦ï¼‰
- [Codecov](https://codecov.io/gh)ã‹ã‚‰`CODECOV_TOKEN`ã‚’å–å¾—ã—ã¦ã‚»ãƒƒãƒˆï¼ˆCodecovä½¿ã‚ãªã„ãªã‚‰ä¸è¦ï¼‰
- [Certificates, Identifiers & Profiles \- Apple Developer](https://developer.apple.com/account/resources/profiles/list)ã§ä½œæˆã—ãŸã‚‚ã®ã‚’`base64 hoge.mobileprovision`ã®ã‚ˆã†ã«Base64ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ã€å„ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼æ¯ã«`MOBILEPROVISION_BASE64_DEV`ã€`MOBILEPROVISION_BASE64_STG`ã€`MOBILEPROVISION_BASE64_PROD`ã€`MOBILEPROVISION_BASE64_APP_STORE`ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆå¿…è¦ãªåˆ†ã ã‘è¨­å®šã™ã‚Œã°è‰¯ã„ï¼‰
- iOSã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã§ãã‚‹p12è¨¼æ˜æ›¸ã‚’ç”¨æ„ã—ã¦ã€`base64 hoge.p12`ã®ã‚ˆã†ã«Base64ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã‚’`P12_BASE64`ã«ã‚»ãƒƒãƒˆã€ã¾ãŸp12ã‚’æ›¸ãå‡ºã—ãŸæ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’`P12_PASSWORD`ã«ã‚»ãƒƒãƒˆã€‚

## ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`scripts`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã£ã¦ä¸­ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œã¦ãŠãï¼ˆshã¯å®Ÿè¡Œæ¨©é™ã‚’å¿˜ã‚Œãšã«`chmod +x ./scripts/*.sh`ï¼‰

- [test.sh](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/test.sh)
- [prebuildiOS.sh](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/prebuildiOS.sh)
- [buildiOS.sh](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/buildiOS.sh)
- [buildAndroid.sh](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/buildAndroid.sh)
- [AdHocExportOptions.plist](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/AdHocExportOptions.plist)
- [AppStoreExportOptions.plist](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/AppStoreExportOptions.plist)

ãªãŠã€`TODO`ã¨ã‚ã‚‹ç®‡æ‰€ã«é–¢ã—ã¦ã¯é©æ™‚å¤‰æ›´ã™ã‚‹ã“ã¨ã€‚

## Codecov

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«[codecov\.yml](https://docs.codecov.io/docs/codecov-yaml)ã‚’é…ç½®ã™ã‚Œã°ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã«ã¯å«ã‚ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ãªã©ã€ã„ã‚ã„ã‚è¨­å®šã§ãã‚‹ã€‚
ä¾‹ãˆã° https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/codecov.yml

## workflow_dispatchã§ãƒ“ãƒ«ãƒ‰

ä½•ã‚‰ã‹ã®ç†ç”±ã§æ‰‹å‹•ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã„å ´åˆã®ã‚¸ãƒ§ãƒ–
[build_app_with_workflow_dispatch\.yml](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/.github/workflows/build_app_with_workflow_dispatch.yml)

æˆæœç‰©ã®å‡ºåŠ›ãªã©ã¯ã›ãšã€ãŸã ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã ã‘

# ã‚¢ãƒ—ãƒªã®æ¨™æº–è¨€èªã‚’æ—¥æœ¬èªã«ã™ã‚‹

[Xcode ã§ã‚¢ãƒ—ãƒªã®æ¨™æº–è¨€èªã‚’æ—¥æœ¬èªã«ã™ã‚‹æ–¹æ³• \- Qiita](https://qiita.com/ko2ic/items/8918034d940f66fee97d)

è¨˜äº‹ã§ã¯`developmentRegion`ã¯`Japanese`ã«ã¨ã‚ã‚‹ãŒ`ja`ã«ã™ã‚‹ã“ã¨

```diff:ios/Runner.xcodeproj/project.pbxproj
- developmentRegion = en
+ developmentRegion = ja
```

## localizationsDelegates

`GlobalWidgetsLocalizations`ãªã©ã‚’æŒ‡å®šã™ã‚‹ãªã‚‰`pubspec.yaml`ã«è¿½è¨˜ã—ã¦ãŠã

```main.dart
    return MaterialApp(
      localizationsDelegates: const [
        GlobalCupertinoLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
      ],
    );
```

```pubspec.yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: any
```

# Firebase Crashlyticsã®dSYM

dSYMã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
[uploadSymbols\.sh](https://github.com/KoheiKanagu/my_flutter_app_template/blob/master/scripts/uploadSymbols.sh)

## å‚è€ƒ

[å¯èª­åŒ–ã•ã‚ŒãŸã‚¯ãƒ©ãƒƒã‚·ãƒ¥ ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹ Â \|Â  Crashlytics Â \|Â  Firebase](https://firebase.google.com/docs/crashlytics/get-deobfuscated-reports-fabric-sdk?hl=ja)
